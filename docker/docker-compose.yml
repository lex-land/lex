version: '3.1'

services:
  lex-nginx:
    image: nginx:latest
    container_name: lex-nginx
    volumes:
      - ../nginx/certs:/etc/nginx/certs
      - ../nginx/conf.d:/etc/nginx/conf.d
    links:
      - lex-node
    depends_on:
      - lex-node
    ports:
      - 80:80
      - 443:443

  lex-node:
    container_name: lex-node
    image: node:latest
    volumes:
      - ../:/app
    working_dir: /app
    command: 'npm start'
    environment:
      # if you have your own mysql, config it here, and disable the 'mysql' config blow
      - MYSQL_URL=lex-mysql # links will maintain /etc/hosts, just use 'container_name'
      - MYSQL_PORT=3306
      - MYSQL_USERNAME=root
      - MYSQL_PASSWD=123456
      - MYSQL_DATABASE=Lex
      - NODE_ENV=production
      - SUNMI_PROD_URL
      - PORT=3000
      - BUILD_TAG
    links:
      - lex-mysql
    depends_on:
      - lex-mysql
    ports:
      - '3000:3000'

  # https://github.com/typeorm/typeorm/issues/2093
  # https://github.com/mysqljs/mysql/issues/2013
  lex-mysql:
    container_name: lex-mysql
    image: mysql:5.6
    volumes:
      # 初始化数据库SQL
      # https://stackoverflow.com/questions/38504257/mysql-scripts-in-docker-entrypoint-initdb-are-not-executed
      - ../server/migration/sql:/docker-entrypoint-initdb.d
      - /data/docker/mysql:/var/lib/mysql
    # 添加默认排序规则
    # https://stackoverflow.com/questions/45729326/how-to-change-the-default-character-set-of-mysql-using-docker-compose
    command:
      [
        'mysqld',
        '--character-set-server=utf8mb4',
        '--collation-server=utf8mb4_unicode_ci',
        '--default-authentication-plugin=mysql_native_password',
      ]
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: '123456'
    ports:
      - 3306:3306
